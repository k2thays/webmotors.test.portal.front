pipeline {
  agent { node ('jenkins-qa-plugin-slave') } 
  
  environment { PROJECT_NAME = "webmotors.portal_front_test" }
  
  stages{ 
  
    stage('Docker build') {
      steps {
        sh """
          docker build -t $PROJECT_NAME . -f Dockerfile
        """
      }
    }
  
    stage('Test: QA Front') {
      steps {
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
        echo 'Execuntado os testes automatizados'
        sh """
           docker run --rm --network host \
           -v ${PWD}/workspace/$PROJECT_NAME/allure-results:/$PROJECT_NAME/allure-results \
           -i $PROJECT_NAME \
           cucumber headless=true -t @smoke
        """
        }
      }
    }
  
    stage('Quality Gate - Report') {
      steps {
        script {
          allure([
            includeProperties: false,
            jdk: '',
            properties: [],
            reportBuildPolicy: 'ALWAYS',
            results: [[path: '/allure-results']]
          ])
        }
        // sh """aws s3 cp  ${PWD}/workspace/$PROJECT_NAME/allure-report/history/history-trend.json s3://webmotors-integrated-tests/reports/PJ/FRONT_COCKPIT/history-trend.json"""
      }
    }
  }
}
